{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Esquema canónico de ítem MCQ (3 o 4 opciones)",
  "type": "object",
  "required": [
    "item_id",
    "testlet_id",
    "estimulo_compartido",
    "metadata",
    "tipo_reactivo",
    "fragmento_contexto",
    "recurso_visual",
    "enunciado_pregunta",
    "opciones",
    "respuesta_correcta_id"
  ],
  "additionalProperties": false,

  "properties": {
    "item_id": {
      "type": "string",
      "description": "UUID v4 único",
      "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$"
    },

    "testlet_id": {
      "type": ["string", "null"],
      "description": "UUID común si el ítem pertenece a un testlet"
    },

    "estimulo_compartido": {
      "type": ["string", "null"],
      "description": "Texto (>100 palabras) o figura compleja (solo primer ítem del testlet)",
      "maxLength": 1500
    },

    "metadata": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "idioma_item",
        "area",
        "asignatura",
        "tema",
        "contexto_regional",
        "nivel_destinatario",
        "nivel_cognitivo",
        "dificultad_prevista",
        "fecha_creacion"
      ],
      "properties": {
        "idioma_item": { "type": "string", "enum": ["es", "en"] },
        "area": { "type": "string" },
        "asignatura": { "type": "string" },
        "tema": { "type": "string" },
        "contexto_regional": { "type": ["string", "null"] },
        "nivel_destinatario": { "type": "string" },
        "nivel_cognitivo": {
          "type": "string",
          "enum": ["recordar", "comprender", "aplicar", "analizar", "evaluar", "crear"]
        },
        "dificultad_prevista": {
          "type": "string",
          "enum": ["facil", "media", "dificil"]
        },
        "referencia_curricular": { "type": ["string", "null"] },
        "habilidad_evaluable": { "type": ["string", "null"] },
        "fecha_creacion": { "type": "string", "format": "date" }
      }
    },

    "tipo_reactivo": {
      "type": "string",
      "enum": ["opción múltiple", "seleccion_unica", "seleccion_multiple", "ordenamiento", "relacion_elementos"]
    },

    "fragmento_contexto": {
      "type": ["string", "null"],
      "description": "Texto breve (<75 palabras) que introduce o contextualiza la pregunta"
    },

    "recurso_visual": {
      "type": ["object", "null"],
      "properties": {
        "tipo": { "type": "string", "enum": ["grafico", "tabla", "diagrama"] },
        "descripcion": { "type": "string", "maxLength": 600 },
        "alt_text": { "type": "string", "maxLength": 250 },
        "referencia": { "type": "string", "format": "uri" },
        "pie_de_imagen": { "type": ["string", "null"], "maxLength": 300 }
      },
      "required": ["tipo", "descripcion", "alt_text", "referencia"],
      "additionalProperties": false
    },

    "enunciado_pregunta": {
      "type": "string",
      "description": "Stem de la pregunta (cuerpo principal)",
      "maxLength": 250
    },

    "opciones": {
      "type": "array",
      "minItems": 3,
      "maxItems": 4,
      "items": {
        "type": "object",
        "required": ["id", "texto", "es_correcta", "justificacion"],
        "properties": {
          "id": { "type": "string", "enum": ["a", "b", "c", "d"] },
          "texto": { "type": "string", "maxLength": 140 },
          "es_correcta": { "type": "boolean" },
          "justificacion": { "type": ["string", "null"], "maxLength": 300 }
        },
        "additionalProperties": false
      }
    },

    "respuesta_correcta_id": {
      "type": "string",
      "description": "ID de la opción correcta",
      "enum": ["a", "b", "c", "d"]
    }
  },

  "allOf": [
    {
      "if": {
        "properties": { "tipo_reactivo": { "const": "seleccion_unica" } }
      },
      "then": {
        "properties": {
          "opciones": { "minItems": 3, "maxItems": 4 },
          "respuesta_correcta_id": { "type": "string" }
        },
        "required": ["respuesta_correcta_id"]
      }
    },
    {
      "if": {
        "properties": { "respuesta_correcta_id": { "const": "a" } }
      },
      "then": {
        "properties": {
          "opciones": {
            "contains": {
              "properties": {
                "id": { "const": "a" },
                "es_correcta": { "const": true }
              }
            }
          }
        }
      }
    },
    {
      "if": {
        "properties": { "respuesta_correcta_id": { "const": "b" } }
      },
      "then": {
        "properties": {
          "opciones": {
            "contains": {
              "properties": {
                "id": { "const": "b" },
                "es_correcta": { "const": true }
              }
            }
          }
        }
      }
    },
    {
      "if": {
        "properties": { "respuesta_correcta_id": { "const": "c" } }
      },
      "then": {
        "properties": {
          "opciones": {
            "contains": {
              "properties": {
                "id": { "const": "c" },
                "es_correcta": { "const": true }
              }
            }
          }
        }
      }
    },
    {
      "if": {
        "properties": { "respuesta_correcta_id": { "const": "d" } }
      },
      "then": {
        "properties": {
          "opciones": {
            "contains": {
              "properties": {
                "id": { "const": "d" },
                "es_correcta": { "const": true }
              }
            }
          }
        }
      }
    }
  ]
}
